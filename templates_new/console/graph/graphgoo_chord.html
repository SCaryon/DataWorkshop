{% extends 'console/layout.html' %}
{% block product_name %}
    GraphGoo
{% endblock %}

{% block product_description %}
    Chord Diagram
{% endblock %}


{% block content %}
<style>
.getdata{
    display: none;
}
</style>

<div class="section topmargin-lg nobottommargin section_product" style="margin:0px !important;">
    <div class="container clearfix">
        <div id="chord_layout">

        </div>
    </div>
</div>

<div class="getdata">
    <ul id="graph_nodes">
        {% for item in nodes %}
            <li>{{ item }}</li>
        {% endfor %}
    </ul>
    <ul id="graph_matrix">
        {% for item in matrix %}
            <li>{{ item }}</li>
        {% endfor %}
    </ul>
</div>

<script src="/static/js/d3.v3.min.js"></script>
<script>
    graph_nodes = new Array();
    arr = document.getElementById("graph_nodes").getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        graph_nodes.push(arr[i].innerHTML);
    }
    var graph_matrix = new Array();
    arr = document.getElementById('graph_matrix').getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML)
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        graph_matrix.push(numArray)
    }
    chord_matrix = [];
    for(i = 0; i < graph_matrix.length; i++){
        row = [];
        for(j = 0; j < graph_matrix[0].length; j++){
            if(!isNaN(graph_matrix[i][j])){
                row.push(graph_matrix[i][j]);
            }
            else{
                row.push(0);
            }
        }
        chord_matrix.push(row);
    }

    var chord_layout=d3.layout.chord()
        .padding(0.06)
        .sortSubgroups(d3.descending())
        .matrix(chord_matrix);
    //生成节点和连线
    var chord_groups=chord_layout.groups();
    var chords=chord_layout.chords();
      //炫图，颜色函数的定义
    var chord_width=600;
    var chord_height=600;
    var chord_innerRadius=chord_width/2*0.7;
    var chord_outerRadius=chord_innerRadius*1.1;
      //声明颜色比例尺
    var chord_color20=d3.scale.category20();
    var chord_svg=d3.select("#chord_layout").append("svg")
        .attr("width",chord_width)
        .attr("height",chord_height)
        .append("g")
        .attr("transform","translate("+chord_width/2+","+chord_height/2+")");
      //绘制节点（即分组，有多少个城市画多少个弧形），及绘制城市名称
    var chord_outer_arc=d3.svg.arc()
        .innerRadius(chord_innerRadius)
        .outerRadius(chord_outerRadius);
    var chord_g_outer=chord_svg.append("g");
    chord_g_outer.selectAll("path")
        .data(chord_groups)
        .enter()
        .append("path")
        .style("fill",function(d){return chord_color20(d.index);})
        .style("stroke",function(d){return chord_color20(d.index);})
        .attr("d",chord_outer_arc);
    chord_g_outer.selectAll("text")
        .data(chord_groups)
        .enter()
        .append("text")
        .attr('fill', 'white')
        .each(function(d,i){
            d.angle=(d.startAngle+d.endAngle)/2;
            d.name=graph_nodes[i];
        })
        .attr("dy",".35em")
        .attr("transform",function(d){
            return "rotate(" + ( d.angle * 180 / Math.PI ) + ")" +
                    ( ( d.angle > Math.PI && d.angle < Math.PI*2 ) ? "translate(0,"+ -1.0*(chord_outerRadius+40) +")" : "translate(0,"+ -1.0*(chord_outerRadius+10) +")")
                //"translate(0,"+ -1.0*(chord_outerRadius+10) +")" +
                + ( ( d.angle > Math.PI && d.angle < Math.PI*2 ) ? "rotate(90)" : "rotate(-90)");
        })
        .attr('font-size', '10px')
        .text(function(d){
            return d.name;
        });
      //5.绘制内部弦（即所有城市人口的来源，即有5*5=25条弧）
    var inner_chord=d3.svg.chord()
                        .radius(chord_innerRadius);
    chord_svg.append("g")
        .attr("class","chord")
        .selectAll("path")
        .data(chords)
        .enter()
        .append("path")
        .attr("d",inner_chord)
        .attr('fill-opacity', 0.67)
        .attr('stroke', 'black')
        .attr('stroke-width', '0.5px')
        .style("fill",function(d){return chord_color20(d.source.index);})
        .style("opacity",1)
        .on("mouseover",function(d,i){
            chord_svg.append('title')
                .attr('id', 'chord_label')
                .text(graph_nodes[d.source.index] + '->' + graph_nodes[d.source.subindex] + ':' + d.source.value
                + '\n' + graph_nodes[d.target.index] + '->' + graph_nodes[d.target.subindex] + ':' + d.target.value)
                .attr('color', 'white');
            d3.select(this).style("fill","yellow");
        })
        .on("mouseout",function(d,i){
            d3.select('#chord_label').remove();
            d3.select(this)
                .transition()
                .duration(1000)
                .style("fill",chord_color20(d.source.index));
        });
</script>

{% endblock %}