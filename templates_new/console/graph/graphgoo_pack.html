{% extends 'console/layout.html' %}
{% block product_name %}
    GraphGoo
{% endblock %}

{% block product_description %}
    Pack Layout
{% endblock %}


{% block content %}
 <style>
.getdata{
    display: none;
}
</style>
<style>
    .node {
        cursor: pointer;
    }
    .node:hover {
        stroke: #000;
        stroke-width: 1.5px;
    }
    .node--leaf {
        fill: white;
    }

    .node--root,
    .node--leaf {
        pointer-events: none;
    }
</style>

<div class="section topmargin-lg nobottommargin section_product" style="margin:0px !important;">
    <div class="container clearfix">
        <div id="pack_layout">
        </div>
    </div>
</div>

<div class="getdata">
    <ul id="graph_nodes">
        {% for item in nodes %}
            <li>{{ item }}</li>
        {% endfor %}
    </ul>
    <ul id="graph_matrix">
        {% for item in matrix %}
            <li>{{ item }}</li>
        {% endfor %}
    </ul>
</div>

<script src="/static/js/d3.v3.min.js"></script>
<script>
    graph_nodes = new Array();
    arr = document.getElementById("graph_nodes").getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        graph_nodes.push(arr[i].innerHTML);
    }
    var graph_matrix = new Array();
    arr = document.getElementById('graph_matrix').getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML)
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        graph_matrix.push(numArray)
    }
    tree_degree = [];
    for(i = 0; i < graph_matrix.length; i++){
        tree_degree.push(0);
    }
    for(i = 0; i < graph_matrix.length; i++){
        for(j = i + 1; j < graph_matrix.length; j++){
            if(!isNaN(graph_matrix[i][j])){
                tree_degree[i]++;
                tree_degree[j]++;
            }
        }
    }
    tree_root = 0;
    for(i = 0; i < tree_degree.length; i++){
        if(tree_degree[i] > tree_degree[tree_root]){
            tree_root = i;
        }
    }

    pack_root = get_tree_data(tree_root, -1);
    console.log(pack_root)
    var pack_margin = 20,
    pack_diameter = 560;

    var pack_color = d3.scale.linear()
        .domain([-1, 5])
        .range(["hsl(152,80%,80%)", "hsl(228,30%,40%)"])
        .interpolate(d3.interpolateHcl);

    var pack = d3.layout.pack()
        .padding(2)
        .size([pack_diameter - pack_margin, pack_diameter - pack_margin])
        .value(function(d) { return d.size; })

    var pack_svg = d3.select("#pack_layout").append("svg")
        .attr("width", pack_diameter)
        .attr("height", pack_diameter)
        .append("g")
        .attr("transform", "translate(" + pack_diameter / 2 + "," + pack_diameter / 2 + ")");

    pack_svg.selectAll("circle").remove();
    pack_svg.selectAll("text").remove();

    var pack_focus = pack_root,
        nodes = pack.nodes(pack_root),
        view;

    var pack_circle = pack_svg.selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
        .style("fill", function(d) {
            return d.children ? pack_color(d.depth) : null; })
        .on("click", function(d) { if (pack_focus !== d) pack_zoom(d), d3.event.stopPropagation(); });

    var pack_text = pack_svg.selectAll("text")
        .data(nodes)
        .enter()
        .append("text")
        .attr("class", "label")
        .attr("pointer-events", "none")
        .attr("font", '11px "Helvetica Neue", Helvetica, Arial, sans-serif')
        .attr("text-shadow", '0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff')
        .attr("text-anchor", 'middle')
        .style("fill-opacity", function(d) { return d.parent === pack_root ? 1 : 0; })
        .style("display", function(d) {
          return d.parent === pack_root ? "inline" : "none"; })
        .text(function(d) { return d.name; });

    var pack_node = pack_svg.selectAll("circle,text");

    d3.select("body")
        .on("click", function() { pack_zoom(pack_root); });

    pack_zoomTo([pack_root.x, pack_root.y, pack_root.r * 2 + pack_margin]);

    function pack_zoom(d) {
        var focus0 = pack_focus; pack_focus = d;

        var transition = d3.transition()
            .duration(d3.event.altKey ? 7500 : 750)
            .tween("zoom", function(d) {
                var i = d3.interpolateZoom(view, [pack_focus.x, pack_focus.y, pack_focus.r * 2 + pack_margin]);
                return function(t) { pack_zoomTo(i(t)); };
            });

        transition.selectAll("text")
            .filter(function(d) { return d.parent === pack_focus || this.style.display === "inline"; })
            .style("fill-opacity", function(d) { return d.parent === pack_focus ? 1 : 0; })
            .each("start", function(d) { if (d.parent === pack_focus) this.style.display = "inline"; })
            .each("end", function(d) { if (d.parent !== pack_focus) this.style.display = "none"; });
    }

    function pack_zoomTo(v) {
      var k = pack_diameter / v[2]; view = v;
      pack_node.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
      pack_circle.attr("r", function(d) { return d.r * k; });
    }

    d3.select(self.frameElement).style("height", pack_diameter + "px");

    function get_tree_data(n, p){
        var object={};
        object.name=graph_nodes[n];
        if(p == -1){
            object.parent = "null";
        }
        else{
            object.parent = graph_nodes[p]
        }
        var cn = 0;
        for(var j = n + 1; j < graph_nodes.length; j++){
            if(!isNaN(graph_matrix[n][j])){
                cn++;
            }
        }
        if(!cn){
            object.size = Math.floor(Math.random() * 1000 + 1);
		    return object;
        }
	    var children = [];
	    for(var j = n + 1; j < graph_nodes.length; j++){
		    if(!isNaN(graph_matrix[n][j])){
			    var sub_object = get_tree_data(j, n);
			    children.push(sub_object);
		    }
	    }
	    object.children = children;
	    return object;
    }
</script>
{% endblock %}