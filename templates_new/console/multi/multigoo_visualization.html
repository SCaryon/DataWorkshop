{% extends 'console/layout.html' %}
{% block product_name %}
    MultiGoo
{% endblock %}

{% block product_description %}
    Visualization
{% endblock %}


{% block content %}

    <link rel="stylesheet" href="/static/css/bootstrap/bootstrap.css">
    <link rel="stylesheet" href="/static/font-awesome-4.7.0/css/font-awesome.css">
    <link rel="stylesheet" href="/static/css/bootstrap/tooplate-style.css">

    <link rel="stylesheet" href="/static/css/tablegoo/tablegoo_homepage.css">
    <link rel="stylesheet" href="/static/css/tablegoo/parallel.css">
    <link rel="stylesheet" href="/static/css/tablegoo/radviz.css">
    <link rel="stylesheet" href="/static/css/tablegoo/scatter.css">

    <link rel="stylesheet" type="text/css" href="/static/css/user/user.css">


<div class="section topmargin-lg nobottommargin section_product" style="margin:0px !important;">
    <div class="container clearfix">

        <div class="section-title col-lg-4">
            <h1>Analysis</h1>
        </div>
        <div class="col-lg-4 table_upload">
            <form method="post" action="/table_upload" enctype="multipart/form-data" style="margin-top: 50px;margin-left: 50px;">
                <input  type="file"  style="display:none" name="file" id="file">
                <div id="data_file_path" class="fa fa-plus-circle"
                     onclick="file.click()" rel="tooltip" data-placement="top" data-original-title="select your file" style="margin-left: 20px;margin-right: 50px;"></div>
                <input id='upload_kg' name="upload_kg" type="submit" style="display:none" >
                <div class='fa fa-upload' onclick="upload_kg.click()" rel="tooltip" data-placement="top" data-original-title="upload your file"></div>
            </form>
        </div>

        <div class="col-md-12">
            <div class="smart-body">
                <ul class="nav nav-tabs primary bordered">
                    <li class="active">
                        <a href="#analysis_attributions_analysis" data-toggle="tab">
                            <span class="visible-xs"><i class="icon-home"></i></span>
                            <span class="hidden-xs">Attributes Analysis</span>
                        </a>
                    </li>
                    <li>
                        <a href="#analysis_cluster_embedding" data-toggle="tab">
                            <span class="visible-xs"><i class="icon-man"></i></span>
                            <span class="hidden-xs">Cluster&Embedding</span>
                        </a>
                    </li>
                    <li>
                        <a href="#analysis_anomaly_detection" data-toggle="tab">
                            <span class="visible-xs"><i class="icon-email"></i></span>
                            <span class="hidden-xs">Anomaly Detection</span>
                        </a>
                    </li>

                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade active in" id="analysis_attributions_analysis">
                                <div class="slimScrollBar" style="position: relative; overflow: hidden; width: auto; height: 450px;">
                                    <div class="scrollable" data-height="120" style="overflow: hidden; width: auto; height: 450px;">
                                        <div class="row">
                                            <div class="col-lg-3" id="analysis_list">
                                                <div class="col-xs-12 smart-margin-bottom-20">
                                                    <button id="corr_matrix_button" onclick="set_corr_matrix_svg_visual()" rel="tooltip" data-placement="right" data-original-title="change the method" type="button" class="btn"><i class="fa fa-exchange"></i></button>
                                                </div>
                                            </div>
                                            <div class="col-lg-5" id="analysis_corr_matrix_svg" style="display: none">
                                                <text>Order:</text>
                                                <div>
                                                    <select id="order">
                                                        <option value="name">by Name</option>
                                                        <option value="count">by Correlation</option>
                                                        <option value="group">by Cluster</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-lg-5" id="analysis_attributions_analysis_svg" style="display: inline"></div>
                                            <div class="col-lg-3" id="analysis_corr_force_info" >
                                                <div class="panel panel-default">
                                                    <div class="panel-body">
                                                        We calculate the correlation coefficient between
                                                        all pairs of attributes and draw a graph. The nodes
                                                        of the graph represent the attributes. The correlation
                                                        between the pairs of attributes whose absolute value
                                                        is greater than 0.4, and the line length represents
                                                        the absolute value of the correlation coefficient.
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3" id="analysis_corr_matrix_info" style="display: none">
                                                <div class="panel panel-default">
                                                    <div class="panel-body">
                                                        We calculate the correlation coefficient between
                                                        all pairs of attributes and draw a matrix graph.
                                                        Each rectangle represents a pair of attributes.
                                                        The brighter the color of the rectangle, the higher
                                                        the correlation coefficient.You can put the mouse on
                                                        the rectangle to check the correlation coefficient
                                                        between the two attributes.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    <div class="tab-pane fade in" id="analysis_cluster_embedding">
                                <div class="row">
                                    <div class="col-lg-1" id="analysis_list">
                                        <div class="col-xs-12 smart-margin-bottom-20">
                                            <button id="corr_matrix_button" onclick="action_performed('/cluster')" rel="tooltip" data-placement="right" data-original-title="cluster methods" type="button" class="btn"><i class="fa fa-edit"></i></button>
                                        </div>
                                        <div class="col-xs-12 smart-margin-bottom-20">
                                            <button id="corr_matrix_button" onclick="action_performed('/embedding')" rel="tooltip" data-placement="right" data-original-title="embedding methods" type="button" class="btn"><i class="fa fa-edit"></i></button>
                                        </div>
                                    </div>
                                    <div class="col-lg-5" id="analysis_cluster_embedding_svg"></div>
                                    <div class="col-lg-6" id="analysis_user_image"></div>
                                </div>
                            </div>
                    <div class="tab-pane fade in" id="analysis_anomaly_detection">
                        <div class="row">
                            <div class="col-lg-3" id="analysis_list"></div>
                            <div class="col-lg-6" id="analysis_anomaly_detection_svg"></div>
                            <div class="col-lg-3" id="analysis_info"></div>
                        </div>
                        </div>
                </div>
            </div>
        </div>




    <div class="section-title col-lg-4">
    </div>
    <div class="section-title col-lg-4">
        <h1>Visual Charts</h1>
    </div>
    <div class="col-lg-4 table_upload">
        <form method="post" action="/table_upload" enctype="multipart/form-data" style="margin-top: 50px;margin-left: 50px;">
            <input  type="file"  style="display:none" name="file2" id="file2">
            <div id="data_file_path2" class="fa fa-plus-circle"
                 onclick="file2.click()" rel="tooltip" data-placement="top" data-original-title="select your file"  style="margin-left: 20px;margin-right: 50px;"></div>
            <input id='upload_kg2' name="upload_kg2" type="submit" style="display:none" >
            <div class='fa fa-upload' onclick="upload_kg2.click()" rel="tooltip" data-placement="top" data-original-title="upload your file"></div>
        </form>
    </div>
    <div class="col-md-12">
						<div class="smart-body">
							<ul class="nav nav-tabs primary bordered">
								<li class="active">
									<a href="#draw_radviz" data-toggle="tab">
										<span class="visible-xs"><i class="icon-home"></i></span>
										<span class="hidden-xs">Radviz</span>
									</a>
								</li>
								<li>
									<a href="#draw_scatter" data-toggle="tab">
										<span class="visible-xs"><i class="icon-man"></i></span>
										<span class="hidden-xs">Scatter Plot</span>
									</a>
								</li>
								<li>
									<a href="#draw_parallel" data-toggle="tab">
										<span class="visible-xs"><i class="icon-email"></i></span>
										<span class="hidden-xs">Parallel Coordinates</span>
									</a>
								</li>

							</ul>
							<div class="tab-content">
								<div class="tab-pane fade active in" id="draw_radviz">
									<div class="slimScrollBar" style="position: relative; overflow: hidden; width: auto; height: 450px;">
										<div class="scrollable" data-height="120" style="overflow: hidden; width: auto; height: 450px;">
                                            <div class="row">
                                                <div id="radviz_select_bar">
                                                    <!-- CENTER COLUMN -->
                                                    <div class="radviz_column-center">
                                                        <div id="visDiv"></div>
                                                    </div>
                                                    <!-- LEFT COLUMN -->
                                                    <div class="radviz_column-left">
                                                        <form action="" id="setVars" class="radviz_displayStyle">
                                                            <p style="margin-bottom: 10px;margin-top: 15px;" class="radviz_title">Select Variables</p>
                                                            <table>
                                                                <tbody>
                                                                <tr>
                                                                    <td id="numeric" class="radviz_selectionAlignment"></td>
                                                                </tr>
                                                                </tbody>
                                                            </table>
                                                        </form>
                                                        <form action="" id="setColorVar" class="radviz_displayStyle">
                                                            <p>Color by:</p>
                                                            <table>
                                                                <tbody>
                                                                <tr>
                                                                    <td id="colorVar" class="radviz_selectionAlignment">
                                                                        <g>
                                                                            <input type="radio" value="-1" label="None" name="colorAttribute"
                                                                                   checked="">
                                                                            <text>None</text>
                                                                            <p></p>
                                                                        </g>
                                                                        <g id="colorGroup"></g>
                                                                    </td>
                                                                </tr>
                                                                </tbody>
                                                            </table>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
								<div class="tab-pane fade in" id="draw_scatter">

                                </div>
								<div class="tab-pane fade in" id="draw_parallel">

                                </div>
							</div>
						</div>
					</div>


<div class="getdata">
    <ul id="table_features">
        {% for feature in features_list %}
            <li>{{ feature }}</li>
        {% endfor %}
    </ul>
    <ul id="get_corr_data">
        {% for m in corr %}
            <li>{{ m }}</li>
        {% endfor %}
    </ul>
    <ul id="cluster_embedding_data">
        {% for name in cluster_embedding_data %}
            <li>{{ name }}</li>
        {% endfor %}
    </ul>
    <ul id="n_clusters">
        <li>{{ n_clusters }}</li>
    </ul>
    <ul id="data_dictionary">
        {% for d in data_dictionary %}
            <li>{{ d }}</li>
        {% endfor %}
    </ul>
    <ul id="attributions_analysis_data">
        {% for name in attributions_analysis_data %}
            <li>{{ name }}</li>
        {% endfor %}
    </ul>
    <ul id="anomaly_detection_data">
        {% for name in anomaly_detection_data %}
            <li>{{ name }}</li>
        {% endfor %}
    </ul>
    <ul id="cluster_method">
        <li>{{ cluster_method }}</li>
    </ul>
    <ul id="embedding_method">
        <li>{{ embedding_method }}</li>
    </ul>
    <ul id="features_dictionary">
        {% for d in features_dictionary %}
            <li>{{ d }}</li>
        {% endfor %}
    </ul>
    <ul id="no_identifiers_data_dictionary">
        {% for d in no_identifiers_data_dictionary %}
            <li>{{ d }}</li>
        {% endfor %}
    </ul>
    <ul id="no_identifiers_data_list">
        {% for d in no_identifiers_data_list %}
            <li>{{ d }}</li>
        {% endfor %}
    </ul>
    <ul id="no_identifiers_data_list_transform">
        {% for d in no_identifiers_data_list_transform %}
            <li>{{ d }}</li>
        {% endfor %}
    </ul>
    <ul id="data_list">
        {% for d in data_list %}
            <li>{{ d }}</li>
        {% endfor %}
    </ul>
    <ul id="visualization_method">
        <li>{{ visualization_method }}</li>
    </ul>
</div>

<div style="display: none;">
<ul class="section-btn">
    <a onclick="download_report()" class="smoothScroll"><span data-hover="Analysis Report">Analysis Report</span></a>
</ul>
</div>

    </div>
</div>


<!-- SCRIPTS -->
<script src="/static/js/bootstrap/jquery.js"></script>
<script src="/static/js/bootstrap/bootstrap.min.js"></script>
<script src="/static/js/bootstrap/jquery.parallax.js"></script>
<script src="/static/js/bootstrap/modernizr.custom.js"></script>
<script src="/static/js/bootstrap/SmoothScroll.js"></script>
<script src="/static/js/bootstrap/main.js"></script>
<script src="/static/js/bootstrap/custom.js"></script>
<script src="/static/js/d3.vs.min.js"></script>
<script src="/static/js/tablegoo/tab.js"></script>
<script src="/static/js/tablegoo/xdoc.js"></script>
<script src="/static/js/tablegoo/baiduTemplate.js"></script>
<script src="/static/js/tablegoo/parallel.js"></script>
<script src="/static/js/tablegoo/radviz.js"></script>
<script src="/static/js/tablegoo/scatter.js"></script>
<script src="/static/js/tablegoo/fisheye.js"></script>
<script src="/static/js/tablegoo/attribution.js"></script>
<script>
    function action_performed(url){
        window.location.href = url;
    }
</script>
<!--data-->
<script>
    features_dictionary = new Array();
    arr = document.getElementById("features_dictionary").getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        features_dictionary.push(arr[i].innerHTML);
    }

    no_identifiers_data_dictionary = new Array();
    arr = document.getElementById("no_identifiers_data_dictionary").getElementsByTagName('li');
    for (i = 0; i < arr.length; i++) {
        arr_str = arr[i].innerHTML;
        obj = eval('(' + arr_str + ')');
        no_identifiers_data_dictionary.push(obj)
    }

    var no_identifiers_data_list = new Array();
    arr = document.getElementById('no_identifiers_data_list').getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML)
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        no_identifiers_data_list.push(numArray)
    }

    var no_identifiers_data_list_transform = new Array();
    arr = document.getElementById('no_identifiers_data_list_transform').getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML)
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        no_identifiers_data_list_transform.push(numArray)
    }

    /*var data_list = new Array();
    arr = document.getElementById('data_list').getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML)
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        data_list.push(numArray)
    }*/
    features_string = "";
    means = "";
    medians = "";
    modes = "";
    minimums = "";
    maximums = "";
    variances = "";
    feature_list = new Array();
    array = document.getElementById("table_features").getElementsByTagName("li");
    first_feature = array[0].innerHTML;
    for (i = 1; i < array.length; i++) {
        feature_list.push(array[i].innerHTML);
    }
    for (i = 1; i < array.length; i++) {
        features_string = features_string + '"' + array[i].innerHTML + '"' + " ";
    }
    /*array = document.getElementById("means").getElementsByTagName("li");
    for (i = 0; i < array.length; i++) {
        means = means + '"' + array[i].innerHTML + '"' + " ";
    }
    array = document.getElementById("medians").getElementsByTagName("li");
    for (i = 0; i < array.length; i++) {
        medians = medians + '"' + array[i].innerHTML + '"' + " ";
    }
    array = document.getElementById("modes").getElementsByTagName("li");
    for (i = 0; i < array.length; i++) {
        modes = modes + '"' + array[i].innerHTML + '"' + " ";
    }
    array = document.getElementById("minimums").getElementsByTagName("li");
    for (i = 0; i < array.length; i++) {
        minimums = minimums + '"' + array[i].innerHTML + '"' + " ";
    }
    array = document.getElementById("maximums").getElementsByTagName("li");
    for (i = 0; i < array.length; i++) {
        maximums = maximums + '"' + array[i].innerHTML + '"' + " ";
    }
    array = document.getElementById("variances").getElementsByTagName("li");
    for (i = 0; i < array.length; i++) {
        variances = variances + '"' + array[i].innerHTML + '"' + " ";
    }
    stt_data = new Array();
    stt_data.push(features_string);
    stt_data.push(means);
    stt_data.push(medians);
    stt_data.push(modes);
    stt_data.push(minimums);
    stt_data.push(maximums);
    stt_data.push(variances);
    stt_variables = ["mean", "median", "mode", "minimum", "maximum", "variance"];
    statistics_strings = "   The attributions of the dataset are " + features_string + ', and';
    for (i = 0; i < stt_variables.length; i++) {
        statistics_strings = statistics_strings + " the " + stt_variables[i] + " of them";
        statistics_strings = statistics_strings + " is " + stt_data[i + 1] + ",";
    }
    statistics_strings = statistics_strings + " as shown in the table.";
    */
    corr_data = new Array();
    var arr = document.getElementById("get_corr_data").getElementsByTagName('li'), temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML);
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        corr_data.push(numArray);
    }
    corr_strings = '';
    for (i = 0; i < feature_list.length; i++)
        for (j = i + 1; j < feature_list.length; j++) {
            if (corr_data[i][j] > 0.95) {
                corr_strings = corr_strings + '"' + feature_list[i] + '" and "' + feature_list[j] + '" are highly positive correlated-their correlations is ' + corr_data[i][j] + '. ';
            }
            if (corr_data[i][j] < -0.95) {
                corr_strings = corr_strings + '"' + feature_list[i] + '" and "' + feature_list[j] + '" are highly negative correlated-their correlations is ' + corr_data[i][j] + '. ';
            }
        }
    attributes_string = '   We computed the pairwise correlations among all attributes.';
    attributes_string = attributes_string + corr_strings;
    attributes_string = attributes_string + ' Other pairs do not show much correlations.';

    colors = ["purple", "maroon", "navy", "aqua", "lime", "sliver", "red", "yellow", "blue", "darkslategray"];
    d3Colors = d3.scale.ordinal().range(["purple", "maroon", "navy", "aqua", "lime", "sliver", "red", "yellow", "blue", "darkslategray"]);
    arr = document.getElementById("cluster_method").getElementsByTagName('li');
    cluster_method = arr[0].innerHTML;
    arr = document.getElementById("embedding_method").getElementsByTagName('li');
    embedding_method = arr[0].innerHTML;
    arr = document.getElementById("data_dictionary").getElementsByTagName('li'), data_dictionary = [];
    for (i = 0; i < arr.length; i++) {
        arr_str = arr[i].innerHTML;
        var obj = eval('(' + arr_str + ')');
        data_dictionary.push(obj);
    }
    identifiers_list = [];
    for(i = 0; i < data_dictionary.length; i++){
        identifiers_list.push(data_dictionary[i][first_feature]);
    }
    cluster_embedding_dataset = new Array()
    arr = document.getElementById("cluster_embedding_data").getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML);
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        cluster_embedding_dataset.push(numArray);
    }
    arr = document.getElementById("n_clusters").getElementsByTagName('li');
    temp = arr[0].innerHTML;
    clusters = parseInt(temp);
    indexes = [];
    indexes_string = "Samples marked by ID ";
    for (j = 0; j < clusters; j++) {
        each_indexes = [];
        each_indexes_string = '';
        for (i = 0; i < cluster_embedding_dataset.length; i++) {
            if (cluster_embedding_dataset[i][2] == j) {
                each_indexes.push(i);
                each_indexes_string = each_indexes_string + '"' + i + '"' + " ";
            }
        }
        if (each_indexes.length > 10) {
            each_indexes_string = '';
            for (i = 0; i < 10; i++) {
                each_indexes_string = each_indexes_string + '"' + each_indexes[i] + '"' + " ";
            }
            each_indexes_string = each_indexes_string + '...... '
        }
        indexes.push(each_indexes);
        indexes_string = indexes_string + each_indexes_string + 'belongs to the group colored by "' + colors[j] + '" with ' + each_indexes.length + ' members. ';
    }
    cluster_strings = '   We applied the "' + cluster_method + '" cluster analysis.';
    cluster_strings = cluster_strings + 'The dataset can roughly divided as ' + clusters.toString() + ' groups.';
    cluster_strings = cluster_strings + indexes_string;
    embedding_string = '   To better find the feature, we applied "' + embedding_method + '" to show them. ' +
    'The dataset is projected from n-dimensional to two-dimensional';
    users_image = [];
    user_image_data = [];
    /**/for(i = 0; i < clusters; i++){
        each_row = [];
        for(j = 0; j < feature_list.length; j++){
            sum = 0;
            for(k = 0; k < indexes[i].length; k++){
                sum += no_identifiers_data_list[indexes[i][k]][j];
            }
            each_row.push(sum/indexes[i].length);
        }
        users_image.push(each_row);
    }

    /*attributions_analysis_dataset = [];
    arr = document.getElementById("attributions_analysis_data").getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML);
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        attributions_analysis_dataset.push(numArray);
    }*/

    anomaly_detection_dataset = [];
    arr = document.getElementById("anomaly_detection_data").getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML);
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        anomaly_detection_dataset.push(numArray);
    }

    /*regression_dataset = [];
    arr = document.getElementById("regression_data").getElementsByTagName('li');
    temp = [];
    for (i = 0; i < arr.length; i++) {
        temp.push(arr[i].innerHTML);
    }
    for (i = 0; i < temp.length; i++) {
        temp1 = temp[i].replace('[', '');
        temp2 = temp1.replace(']', '');
        temp3 = temp2.split(",");
        numArray = temp3.map((value) => {
            return parseFloat(value);
        });
        regression_dataset.push(numArray);
    }
    */
    arr = document.getElementById("visualization_method").getElementsByTagName('li');
    visualization_method = arr[0].innerHTML;

    nodes = [];
    links = [];
    for(i = 0; i < feature_list.length; i++){
        object = {};
        object.name = feature_list[i];
        object.group = 1;
        nodes.push(object);
        for(j = i + 1; j < feature_list.length; j++){
            if(corr_data[i][j] < -0.4 || corr_data[i][j] > 0.4){
                object = {};
                object.source = i;
                object.target = j;
                object.corr_data = corr_data[i][j];
                links.push(object);
            }
        }
    }
    attributions_analysis_jsondata = {};
    attributions_analysis_jsondata.nodes = nodes;
    attributions_analysis_jsondata.links = links;

    nodes = [];
    links = [];
    for(i = 0; i < feature_list.length; i++){
      object = {};
      object.name = feature_list[i];
      object.group = 1;
      nodes.push(object);
      for(j = 0; j < feature_list.length; j++){
          object = {};
          object.source = i;
          object.target = j;
          object.value = corr_data[i][j];
          links.push(object);
      }
    }

  corr_matrix_json_data = {};
  corr_matrix_json_data.nodes = nodes;
  corr_matrix_json_data.links = links;

    analysis_svgsize = 400;
    padding = 5;
</script>
<!--attribution-->
<script>
var corr_matrix_margin = {top: 80, right: 0, bottom: 0, left: 80},
    width = 320,
    height = 320;
var x = d3.scale.ordinal().rangeBands([0, width]),
    z = d3.scale.linear().domain([0, 4]).clamp(true),
    c = d3.scale.category10().domain([-10, 10]).range([0,10]);
var linear = d3.scale.linear()
			.domain([0, 20000])
			.range([0, 1]);
		var a = d3.rgb(0,255,255);
		var b = d3.rgb(0,0,255);
		var computeColor = d3.interpolate(a,b);

var corr_matrix_svg = d3.select("#analysis_corr_matrix_svg")
    .append("svg")
    .attr("width", width+corr_matrix_margin.left + 50)
    .attr("height", height+ corr_matrix_margin.top + 50)
    .attr('id','corr_matrix_svg')
    .append("g")
    .attr("transform", "translate(" + corr_matrix_margin.left + "," + corr_matrix_margin.top + ")");

    var defs = corr_matrix_svg.append("defs").append('g').attr('id', 'colorbar');

	var linearGradient = defs.append("linearGradient")
								.attr("id","linearColor")
								.attr("x1","0%")
								.attr("y1","0%")
								.attr("x2","100%")
								.attr("y2","0%");

		var stop1 = linearGradient.append("stop")
						.attr("offset","0%")
						.style("stop-color",a.toString());

		var stop2 = linearGradient.append("stop")
						.attr("offset","100%")
						.style("stop-color",b.toString());

		//添加一个矩形，并应用线性渐变
		var colorRect = corr_matrix_svg.append("rect")
            .attr('x', 20)
            .attr('y', 350)
					.attr("width", 140)
					.attr("height", 30)
					.style("fill","url(#" + linearGradient.attr("id") + ")");

	    var minValueText = corr_matrix_svg.append("text")
					.attr("class","valueText")
					.attr("x", 20)
					.attr("y", 345)
					.attr("dy", "-0.3em")
                    .attr('font-size', '10px')
					.text(function(){
						return -1;
					});

		var maxValueText = corr_matrix_svg.append("text")
					.attr("class","valueText")
					.attr("x", 160)
					.attr("y", 345)
					.attr("dy", "-0.3em")
                    .attr('font-size', '10px')
					.text(function(){
						return 1;
					});



  var matrix = [],
      n = corr_matrix_json_data.nodes.length;

  corr_matrix_json_data.nodes.forEach(function(node, i) {
    node.index = i;
    node.count = 0;
    matrix[i] = d3.range(n).map(function(j) { return {x: j, y: i, z: 0}; });
  });
  // Convert links to matrix; count character occurrences.
  corr_matrix_json_data.links.forEach(function(link) {
    matrix[link.source][link.target].z = (1+link.value)*10000;
    matrix[link.target][link.source].z = (1+link.value)*10000;
    matrix[link.source][link.source].z = 2*10000;
    matrix[link.target][link.target].z = 2*10000;
    corr_matrix_json_data.nodes[link.source].count = (1+link.value) * 10000;
    corr_matrix_json_data.nodes[link.target].count = (1+link.value) * 10000;
  });

  // Precompute the orders.
  var orders = {
    name: d3.range(n).sort(function(a, b) { return d3.ascending(corr_matrix_json_data.nodes[a].name, corr_matrix_json_data.nodes[b].name); }),
    count: d3.range(n).sort(function(a, b) { return corr_matrix_json_data.nodes[b].count - corr_matrix_json_data.nodes[a].count; }),
    group: d3.range(n).sort(function(a, b) { return corr_matrix_json_data.nodes[b].group - corr_matrix_json_data.nodes[a].group; })
  };

  // The default sort order.
  x.domain(orders.name);

  corr_matrix_svg.append("rect")
      .attr("width", width)
      .attr("height", height)
      .attr('fill', '#eee')
      .attr('stroke', 'black');

  var row = corr_matrix_svg.selectAll(".corr_matrix_row")
      .data(matrix)
      .enter().append("g")
      .attr("class", "corr_matrix_row")
      .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .each(row);

  row.append("line")
      .attr("x2", width)
      .attr('stroke', '#fff');

  row.append("text")
      .attr("x", -6)
      .attr("y", x.rangeBand() / 2)
      .attr("dy", ".32em")
      .attr("text-anchor", "end")
      .text(function(d, i) { return corr_matrix_json_data.nodes[i].name; });

  var column = corr_matrix_svg.selectAll(".corr_matrix_column")
      .data(matrix)
    .enter().append("g")
      .attr("class", "corr_matrix_column")
      .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

  column.append("line")
      .attr("x1", -width)
      .attr('stroke', '#fff');

  column.append("text")
      .attr("x", 6)
      .attr("y", x.rangeBand() / 2)
      .attr("dy", ".32em")
      .attr("text-anchor", "start")
      .text(function(d, i) { return corr_matrix_json_data.nodes[i].name; });

  function row(row) {
    var cell = d3.select(this).selectAll(".cell")
        .data(row.filter(function(d) {
          return d.z; }))
        .enter().append("rect")
        .attr("class", "cell")
        .attr("x", function(d) { return x(d.x); })
        .attr("width", x.rangeBand())
        .attr("height", x.rangeBand())
        .style("fill-opacity", function(d) { return z(d.z); })
        .style("fill", function(d) {
            return computeColor(linear(d.z).toString());
            //return c(d.z);
        })
        .on("mouseover", mouseover)
        .on("mouseout", mouseout);
  }

  function mouseover(p) {
    d3.selectAll(".corr_matrix_row text").classed("active", function(d, i) { return i == p.y; });
    d3.selectAll(".corr_matrix_column text").classed("active", function(d, i) { return i == p.x; });
    corr_matrix_svg.append("title")
        .style("fill", "black")
        .attr('text-anchor', 'middle')
        .text('correlation:' + corr_data[p.y][p.x])
        .attr('id', 'box_text');
  }

  function mouseout() {
    d3.selectAll("text").classed("active", false);
    d3.select("#box_text").remove();
  }

  d3.select("#order").on("change", function() {
    clearTimeout(timeout);
    order(this.value);
  });

  function order(value) {
    x.domain(orders[value]);

    var t = corr_matrix_svg.transition().duration(2500);

    t.selectAll(".corr_matrix_row")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .selectAll(".cell")
        .delay(function(d) { return x(d.x) * 4; })
        .attr("x", function(d) { return x(d.x); });

    t.selectAll(".corr_matrix_column")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
  }

  var timeout = setTimeout(function() {
    order("group");
    d3.select("#order").property("selectedIndex", 2).node().focus();
  }, 5000);

  var serializer = new XMLSerializer();
    var corr_matrix_source = serializer.serializeToString(document.getElementById('corr_matrix_svg'));
    corr_matrix_source = '<?xml version="1.0" standalone="no"?>\r\n' + corr_matrix_source;
    var corr_matrix_url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(corr_matrix_source);
    var corr_matrix_canvas = document.createElement("canvas");
    corr_matrix_canvas.width = analysis_svgsize*1.1;
    corr_matrix_canvas.height = analysis_svgsize*1.1;
    var corr_matrix_context = corr_matrix_canvas.getContext("2d");
    var corr_matrix_image = new Image;
    corr_matrix_image.src = corr_matrix_url;
    corr_matrix_image.onload = function () {
        corr_matrix_context.drawImage(corr_matrix_image, 0, 0);
        corr_matrix_svg_url = corr_matrix_canvas.toDataURL("image/png");
    };
</script>
<script>
    var color = d3.scale.category20();
    var fisheye = d3.fisheye.circular()
        .radius(150);
    var force = d3.layout.force()
        .nodes(attributions_analysis_jsondata.nodes)   //指定节点数组
        .links(attributions_analysis_jsondata.links)   //指定连线数组
        .charge(-240)
        .linkDistance(function(d, i){
            return (1 - Math.abs(d.corr_data)) * 300;
        })
        .size([analysis_svgsize, analysis_svgsize]);
    /*var attributions_zoom = d3.behavior.zoom()
        .scaleExtent([0, 20])
        .on("zoom", attributions_zoomed);*/
    var attributions_svg = d3.select("#analysis_attributions_analysis_svg").append("svg")
        .attr("width", analysis_svgsize*1.1)
        .attr("height", analysis_svgsize*1.1)
        .attr('id', 'attributions_svg')
        .attr('border', '1px')
        .append('g')
        //.call(attributions_zoom)
        //.append("g")
        .attr('transform', 'translate(' + 0 + ','+ 0.05*analysis_svgsize + ')');

    attributions_svg.append("rect")
        .attr("class", "analysis_attributions_analysis_svg_background")
        .attr("width", analysis_svgsize)
        .attr("height", analysis_svgsize)
        .attr('fill', 'none')
        .attr('pointer-events', 'all')
        .attr('stroke', 'black');

    var n = attributions_analysis_jsondata.nodes.length;

    attributions_analysis_jsondata.nodes.forEach(function(d, i) {
        d.x = analysis_svgsize / n * Math.floor(Math.random()*(n));
        d.y = analysis_svgsize / n * Math.floor(Math.random()*(n));
    });

    force.start();
    for (var i = n; i > 0; --i) force.tick();
    force.stop();

    var ox = 0, oy = 0;
    attributions_analysis_jsondata.nodes.forEach(function(d) { ox += d.x, oy += d.y; });
    ox = ox / n - analysis_svgsize / 2, oy = oy / n - analysis_svgsize / 2;
    attributions_analysis_jsondata.nodes.forEach(function(d) { d.x -= ox, d.y -= oy; });

    var link = attributions_svg.selectAll(".link")
        .data(attributions_analysis_jsondata.links)
        .enter()
        .append("line")
        .attr("class", "link")
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; })
        .style("stroke",function(d){
            if(d.corr_data<0){
                return 'red';
            }
            else{
                return 'green';
            }
        })
        .style("stroke-width", '1.5px')
        .style("stroke-opacity", '0.6');

    var node = attributions_svg.selectAll(".node")
        .data(attributions_analysis_jsondata.nodes)
        .enter().append("circle")
        .attr("class", "node")
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; })
        .attr("r", 5)
        .style("fill", function(d) { return color(d.group); })
        .call(force.drag)
        .attr('stroke', '#fff')
        .attr('stroke-width', '1.5px');

    var svg_texts = attributions_svg.append("g").selectAll("text")
        .data(attributions_analysis_jsondata.nodes)
        .enter()
        .append("text")
        .style("fill", "black")
        .attr('font-size', '7')
        .attr("dx", 0)
        .attr("dy", 0)
        .text(function(d){
            return d.name;
        })
        .attr("x", function(d){ return d.x; })
            .attr("y", function(d){ return d.y; });

    attributions_svg.on("mousemove", function() {
        fisheye.focus(d3.mouse(this));
        node.each(function(d) { d.fisheye = fisheye(d); })
            .attr("cx", function(d) { return d.fisheye.x; })
            .attr("cy", function(d) { return d.fisheye.y; })
            .attr("r", function(d) { return d.fisheye.z * 5; });

        svg_texts.attr("x", function(d){ return d.fisheye.x; })
            .attr("y", function(d){ return d.fisheye.y; });

        link.attr("x1", function(d) { return d.source.fisheye.x; })
            .attr("y1", function(d) { return d.source.fisheye.y; })
            .attr("x2", function(d) { return d.target.fisheye.x; })
            .attr("y2", function(d) { return d.target.fisheye.y; });
    });

    attributions_svg.append('rect')
        .attr('x', analysis_svgsize - 80)
        .attr('y', 20)
         .attr('width', 10)
         .attr('height', 10)
          .attr('fill', 'red');
    attributions_svg.append('text')
          .attr('x', analysis_svgsize - 70)
         .attr('y', 30)
         .text('negative');

    attributions_svg.append('rect')
         .attr('x', analysis_svgsize - 80)
         .attr('y', 50)
         .attr('width', 10)
         .attr('height', 10)
        .attr('fill', 'green');
    attributions_svg.append('text')
        .attr('x', analysis_svgsize - 70)
        .attr('y', 60)
        .text('positive');


     /*function attributions_zoomed() {
        attributions_svg.attr("transform", "translate(" + attributions_zoom.translate() + ")" + "scale(" + attributions_zoom.scale() + ")");
    }*/

    var serializer = new XMLSerializer();
    var attributions_source = serializer.serializeToString(document.getElementById('attributions_svg'));
    attributions_source = '<?xml version="1.0" standalone="no"?>\r\n' + attributions_source;
    var attributions_url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(attributions_source);
    var attributions_canvas = document.createElement("canvas");
    attributions_canvas.width = analysis_svgsize*1.1;
    attributions_canvas.height = analysis_svgsize*1.1;
    var attributions_context = attributions_canvas.getContext("2d");
    var attributions_image = new Image;
    attributions_image.src = attributions_url;
    attributions_image.onload = function () {
        attributions_context.drawImage(attributions_image, 0, 0);
        attributions_svg_url = attributions_canvas.toDataURL("image/png");
    };
</script>
<!--cluster-->
<script type="text/javascript">
    var brushcell = undefined;
    cx_max = d3.max(cluster_embedding_dataset, function (d) {return d[0];});
    cx_min = d3.min(cluster_embedding_dataset, function (d) {return d[0];});
    cy_max = d3.max(cluster_embedding_dataset, function (d) {return d[1];});
    cy_min = d3.min(cluster_embedding_dataset, function (d) {return d[1];});
    cmax = cx_max > cy_max ? cx_max : cy_max;
    cmin = cx_min < cy_min ? cx_min : cy_min;
    var xScale = d3.scale.linear()
        .domain([cmin, cmax])
        .range([padding, analysis_svgsize - padding]);
    var yScale = d3.scale.linear()
        .domain([cmin, cmax])
        .range([analysis_svgsize - padding, padding]);
    /**/var  brush = d3.svg.brush()
        .x(xScale)
        .y(yScale)
        .extent([0, 0], [0, 0])
        .on("brushstart", brushstart)
        .on("brush", brushed)
        .on("brushend", brushend);
    cluster_svg = d3.select("#analysis_cluster_embedding_svg")       //create svg
        .append('svg')
        .attr('id', 'cluster_svg')
        .attr('width', analysis_svgsize*1.1)
        .attr('height', analysis_svgsize*1.1)
        .append("g")
        .attr('transform', 'translate(' + 0.1*analysis_svgsize + ','+ 0.05*analysis_svgsize + ')');
    /**/d3.select("#analysis_cluster_embedding_svg svg g")
        .call(brush)
        .selectAll("rect")
        .style("fill-opacity", 0.1);
    cluster_svg.append('rect')
        .attr("width", analysis_svgsize)
        .attr("height", analysis_svgsize)
        .attr('fill', 'none')
        .attr('pointer-events', 'all')
        .attr('stroke', 'black');

    circles = cluster_svg.selectAll('circle')
        .data(cluster_embedding_dataset)
        .enter()
        .append('circle')
        .attr("transform", function(d) { return "translate(" + xScale(d[0]) + "," + yScale(d[1]) + ")"; })
        .style('stroke', 'white')
        .attr('r', 4)
        .style('fill', function (d) {
            return d3Colors(d[2])
        })
        .data(data_dictionary)
        .on("mouseover", function (d, i) {
            key_name = new Array();
            for (var key in d) {
                key_value = key + ':' + d[key];
                key_name.push(key_value)
            }
            table = key_name.toString();
            table_n = table.replace(/,/g, '\n');
            cluster_svg.append("title").text('ID:' + i + "\n" + table_n).attr("id", "Ttitle");
            d3.select(this)
                .attr("r", 8);
        })
        .on("mouseout", function (d) {
            d3.select(this)
                .attr("r", 4);
            d3.select("#Ttitle").remove();
        });

    var serializer = new XMLSerializer();
    var cluster_source = serializer.serializeToString(document.getElementById('cluster_svg'));
    cluster_source = '<?xml version="1.0" standalone="no"?>\r\n' + cluster_source;
    var cluster_url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(cluster_source);
    var cluster_canvas = document.createElement("canvas");
    cluster_canvas.width = analysis_svgsize*1.1;
    cluster_canvas.height = analysis_svgsize*1.1;
    var cluster_context = cluster_canvas.getContext("2d");
    var cluster_image = new Image;
    cluster_image.src = cluster_url;
    cluster_image.onload = function () {
        cluster_context.drawImage(cluster_image, 0, 0);
        cluster_svg_url = cluster_canvas.toDataURL("image/png");
    };

    /*window.onload = function() {
        var width = 600, height = 300;
        var data = {
            fieldNames: feature_list,
            values: users_image
        };
        var radius = 100,
            total = feature_list.length,
            level = 5,
            rangeMin = 0,
            rangeMax = 100,
            arc = 2 * Math.PI;
        range_upper = [];
        range_lower = [];
        for(i = 0; i < total; i++){
            var min = users_image[0][i];
            var max = users_image[0][i];
            for(j = 1; j < clusters; j++){
                if(users_image[j][i] < min){
                    min = users_image[j][i];

                }
                if(users_image[j][i] > max){
                    max = users_image[j][i];
                }
            }
            range_lower.push(min);
            range_upper.push(2*max);
        }
        var onePiece = arc/total;
        var polygons = {
            webs: [],
            webPoints: []
        };
        for(var k=level;k>0;k--) {
            var webs = '',
                webPoints = [];
            var r = radius/level * k;
            for(var i=0;i<total;i++) {
                var x = r * Math.sin(i * onePiece),
                    y = r * Math.cos(i * onePiece);
                webs += x + ',' + y + ' ';
                webPoints.push({
                    x: x,
                    y: y
                });
            }
            polygons.webs.push(webs);
            polygons.webPoints.push(webPoints);
        }
        // 计算雷达图表的坐标
        var areasData = [];
        var values = data.values;
        for(var i=0;i<values.length;i++) {
            var value = values[i],
                area = '',
                points = [];
            for(var k=0;k<total;k++) {
                var r = radius * (value[k] - range_lower[k])/(range_upper[k] - range_lower[k]);
                var x = r * Math.sin(k * onePiece),
                    y = r * Math.cos(k * onePiece);
                area += x + ',' + y + ' ';
                points.push({
                    x: x,
                    y: y
                })
            }
            areasData.push({
                polygon: area,
                points: points
            });
        }
        // 创建一个分组用来组合要画的图表元素
        var main = d3.select('#analysis_user_image').append('svg')
            .attr('width', 500)
            .attr('height', 440)
            .append('g')
            .classed('main', true)
            .attr('transform', "translate(" + 500/2 + ',' + analysis_svgsize/2 + ')');
        d3.select('#analysis_user_image svg').append('g')
            .attr('transform', 'translate(' + 0.1*analysis_svgsize + ','+ 0.05*analysis_svgsize + ')')
            .append('rect')
            .attr("width", analysis_svgsize)
            .attr("height", analysis_svgsize)
            .attr('fill', 'none')
            .attr('pointer-events', 'all')
            .attr('stroke', 'black');
        // 绘制网轴
        var webs = main.append('g')
            .classed('webs', true);
        webs.selectAll('polygon')
            .data(polygons.webs)
            .enter()
            .append('polygon')
            .attr('points', function(d) {
                return d;
            })
            .attr('fill', 'white')
            .attr('fill-opacity', 0.5)
            .attr('stroke', 'gray')
            .attr('stroke-dasharray', '10, 5');
        // 添加纵轴
        var lines = main.append('g')
            .classed('lines', true);
        lines.selectAll('line')
            .data(polygons.webPoints[0])
            .enter()
            .append('line')
            .attr('x1', 0)
            .attr('y1', 0)
            .attr('x2', function(d) {
                return d.x;
            })
            .attr('y2', function(d) {
                return d.y;
            })
            .attr('fill', 'white')
            .attr('fill-opacity', 0.5)
            .attr('stroke', 'gray')

        // 添加g分组包含所有雷达图区域
        var areas = main.append('g')
            .classed('areas', true);
        // 添加g分组用来包含一个雷达图区域下的多边形以及圆点
        areas.selectAll('g')
            .data(areasData)
            .enter()
            .append('g')
            .attr('class',function(d, i) {
                return 'area' + (i+1);
            });
        for(var i=0;i<areasData.length;i++) {
            // 依次循环每个雷达图区域
            var area = areas.select('.area' + (i+1)),
                areaData = areasData[i];
            // 绘制雷达图区域下的多边形
            area.append('polygon')
                .attr('points', areaData.polygon)
                .attr('stroke', function(d, index) {
                    return colors[i];
                })
                .attr('fill', function(d, index) {
                    return colors[i];
                })
                .attr('fill-opacity', 0.5);
            // 绘制雷达图区域下的点
            var circles = area.append('g')
                .classed('circles', true);
            circles.selectAll('circle')
                .data(areaData.points)
                .enter()
                .append('circle')
                .attr('cx', function(d) {
                    return d.x;
                })
                .attr('cy', function(d) {
                    return d.y;
                })
                .attr('r', 3)
                .attr('stroke', function(d, index) {
                    return colors[i];
                })
                .attr('fill', function(d, index){
                    return colors[i];
                });
        }
        // 计算文字标签坐标
        var textPoints = [];
        var textRadius = radius + 20;
        for(var i=0;i<total;i++) {
            var x = textRadius * Math.sin(i * onePiece),
                y = textRadius * Math.cos(i * onePiece);
            textPoints.push({
                x: x,
                y: y
            });
        }
        // 绘制文字标签
        var texts = main.append('g')
            .classed('texts', true);
        texts.selectAll('text')
            .data(textPoints)
            .enter()
            .append('text')
            .attr('x', function(d) {
                return d.x;
            })
            .attr('y', function(d) {
                return d.y;
            })
            .text(function(d,i) {
                return data.fieldNames[i];
            });
    }*/


    /**/
    function draw_user_image() {
        if(users_image){
        var width = 600, height = 300;
        var data = {
            fieldNames: feature_list,
            values: users_image
        };
        var radius = 100,
            total = feature_list.length,
            level = 5,
            rangeMin = users_image[0][0],
            rangeMax = users_image[0][0],
            arc = 2 * Math.PI;
        for (i = 0; i < total; i++) {
            if (users_image[0][i] < rangeMin) {
                rangeMin = users_image[0][i];
            }
            if (users_image[0][i] > rangeMax) {
                rangeMax = users_image[0][i];
            }
        }

        // 每项指标所在的角度
        var onePiece = arc / total;
        // 计算网轴的正多边形的坐标
        var polygons = {
            webs: [],
            webPoints: []
        };
        for (var k = level; k > 0; k--) {
            var webs = '',
                webPoints = [];
            var r = radius / level * k;
            for (var i = 0; i < total; i++) {
                var x = r * Math.sin(i * onePiece),
                    y = r * Math.cos(i * onePiece);
                webs += x + ',' + y + ' ';
                webPoints.push({
                    x: x,
                    y: y
                });
            }
            polygons.webs.push(webs);
            polygons.webPoints.push(webPoints);
        }
        // 计算雷达图表的坐标
        var areasData = [];
        var values = data.values;
        for (var i = 0; i < values.length; i++) {
            var value = values[i],
                area = '',
                points = [];
            for (var k = 0; k < total; k++) {
                var r = radius * (value[k] - rangeMin) / (rangeMax - rangeMin);
                var x = r * Math.sin(k * onePiece),
                    y = r * Math.cos(k * onePiece);
                area += x + ',' + y + ' ';
                points.push({
                    x: x,
                    y: y
                })
            }
            areasData.push({
                polygon: area,
                points: points
            });
        }
        // 创建一个分组用来组合要画的图表元素

        var main = d3.select('#analysis_user_image').append('svg')
            .attr('width', 500)
            .attr('height', 440)
            .append('g')
            .classed('main', true)
            .attr('transform', "translate(" + 500 / 2 + ',' + analysis_svgsize / 2 + ')');
        d3.select('#analysis_user_image svg').append('g')
            .attr('transform', 'translate(' + 0.1 * analysis_svgsize + ',' + 0.05 * analysis_svgsize + ')')
            .append('rect')
            .attr("width", analysis_svgsize)
            .attr("height", analysis_svgsize)
            .attr('fill', 'none')
            .attr('pointer-events', 'all')
            .attr('stroke', 'black');
        // 绘制网轴
        var webs = main.append('g')
            .classed('webs', true);
        webs.selectAll('polygon')
            .data(polygons.webs)
            .enter()
            .append('polygon')
            .attr('points', function (d) {
                return d;
            })
            .attr('fill', 'white')
            .attr('fill-opacity', 0.5)
            .attr('stroke', 'gray')
            .attr('stroke-dasharray', '10, 5');
        // 添加纵轴
        var lines = main.append('g')
            .classed('lines', true);
        lines.selectAll('line')
            .data(polygons.webPoints[0])
            .enter()
            .append('line')
            .attr('x1', 0)
            .attr('y1', 0)
            .attr('x2', function (d) {
                return d.x;
            })
            .attr('y2', function (d) {
                return d.y;
            })
            .attr('fill', 'white')
            .attr('fill-opacity', 0.5)
            .attr('stroke', 'gray');

        // 添加g分组包含所有雷达图区域
        var areas = main.append('g')
            .classed('areas', true);
        // 添加g分组用来包含一个雷达图区域下的多边形以及圆点
        areas.selectAll('g')
            .data(areasData)
            .enter()
            .append('g')
            .attr('class', function (d, i) {
                return 'area' + (i + 1);
            });
        for (var i = 0; i < areasData.length; i++) {
            // 依次循环每个雷达图区域
            var area = areas.select('.area' + (i + 1)),
                areaData = areasData[i];
            // 绘制雷达图区域下的多边形
            area.append('polygon')
                .attr('points', areaData.polygon)
                .attr('stroke', function (d, index) {
                    return colors[i];
                })
                .attr('fill', function (d, index) {
                    return colors[i];
                })
                .attr('fill-opacity', 0.5);
            // 绘制雷达图区域下的点
            var circles = area.append('g')
                .classed('circles', true);
            circles.selectAll('circle')
                .data(areaData.points)
                .enter()
                .append('circle')
                .attr('cx', function (d) {
                    return d.x;
                })
                .attr('cy', function (d) {
                    return d.y;
                })
                .attr('r', 3)
                .attr('stroke', function (d, index) {
                    return colors[i];
                })
                .attr('fill', function (d, index) {
                    return colors[i];
                });
        }
        // 计算文字标签坐标
        var textPoints = [];
        var textRadius = radius + 20;
        for (var i = 0; i < total; i++) {
            var x = textRadius * Math.sin(i * onePiece),
                y = textRadius * Math.cos(i * onePiece);
            textPoints.push({
                x: x,
                y: y
            });
        }
        // 绘制文字标签
        var texts = main.append('g')
            .classed('texts', true);
        texts.selectAll('text')
            .data(textPoints)
            .enter()
            .append('text')
            .attr('x', function (d) {
                return d.x;
            })
            .attr('y', function (d) {
                return d.y;
            })
            .text(function (d, i) {
                return data.fieldNames[i];
            });
        }
    }

    function brushstart() {
        users_image = [];
        user_image_data = [];
        cluster_svg.selectAll('circle')
            .data(cluster_embedding_dataset);
        if(brushcell !== this){
            d3.select(brushcell).call(brush.clear());
            brushcell = this;
        }
        if(d3.select('#analysis_user_image svg')){
                d3.select('#analysis_user_image svg').remove();
            }
            draw_user_image();
    }

    function brushed() {
        var extend = brush.extent();
        var xmin = extend[0][0];
        var xmax = extend[1][0];
        var ymin = extend[0][1];
        var ymax = extend[1][1];
        user_image_data = [];
        cluster_svg.selectAll('circle')
            .classed("hidden", function (d, i) {
               if(!(d[0] < xmin || d[0] > xmax || d[1] < ymin || d[1] > ymax)){
                    user_image_data.push(no_identifiers_data_list[i]);
                }
                return d[0] < xmin || d[0] > xmax || d[1] < ymin || d[1] > ymax
            })
    }

    function brushend() {
        if (brush.empty()){
            cluster_svg.selectAll(".hidden").classed("hidden", false);
        }
        each_row = [];
            for (j = 0; j < feature_list.length; j++) {
                sum = 0;
                for (k = 0; k < user_image_data.length; k++) {
                    sum += user_image_data[k][j];
                }
                each_row.push(sum / user_image_data.length);
            }
            users_image.push(each_row);
            if(d3.select('#analysis_user_image svg')){
                d3.select('#analysis_user_image svg').remove();
            }
            draw_user_image();
        cluster_svg.selectAll('circle')
            .data(data_dictionary);
    }

</script>
<!--anomaly-->
<script>
    var brushcell = undefined;
    cx_max = d3.max(cluster_embedding_dataset, function (d) {return d[0];});
    cx_min = d3.min(cluster_embedding_dataset, function (d) {return d[0];});
    cy_max = d3.max(cluster_embedding_dataset, function (d) {return d[1];});
    cy_min = d3.min(cluster_embedding_dataset, function (d) {return d[1];});
    cmax = cx_max > cy_max ? cx_max : cy_max;
    cmin = cx_min < cy_min ? cx_min : cy_min;
    var xScale = d3.scale.linear()
        .domain([cmin, cmax])
        .range([padding, analysis_svgsize - padding]);
    var yScale = d3.scale.linear()
        .domain([cmin, cmax])
        .range([analysis_svgsize - padding, padding]);
    /*var anomaly_zoom = d3.behavior.zoom()
        .scaleExtent([0, 20])
        .on("zoom", anomaly_zoomed);*/
    var anomaly_svg = d3.select("#analysis_anomaly_detection_svg").append("svg")
        .attr("width", analysis_svgsize*1.1)
        .attr("height", analysis_svgsize*1.1)
        .attr('id', 'anomaly_svg')
        .append('g')
        //.call(anomaly_zoom)
        //.append("g")
        .attr('transform', 'translate(' + 0.1*analysis_svgsize + ','+ 0.05*analysis_svgsize + ')');
    anomaly_svg.append('rect')
        .classed("frame", true)
        .attr("width", analysis_svgsize)
        .attr("height", analysis_svgsize)
        .attr('fill', 'none')
        .attr('pointer-events', 'all')
        .attr('stroke', 'black');
    circles = anomaly_svg.selectAll('circle')
        .data(anomaly_detection_dataset)
        .enter()
        .append('circle')
        .attr('cx', function (d) {
            return xScale(d[0]);
        })
        .attr('cy', function (d) {
            return yScale(d[1]);
        })
        .style('stroke', 'white')
        .attr('r', 4)
        .style('fill', function (d) {
            return d3Colors(d[2]);
        })
        .on("mouseover", function (d, i) {
            key_name = new Array();
            for (var key in data_dictionary[d[3]]) {
                console.log(data_dictionary[d[3]]);
                key_value = key + ':' + data_dictionary[d[3]][key];
                key_name.push(key_value)
            }
            table = key_name.toString();
            table_n = table.replace(/,/g, '\n');
            anomaly_svg.append("title").text('ID:' + i + "\n" + table_n).attr("id", "Ttitle");
            d3.select(this)
                .attr("r", 8);
        })
        .on("mouseout", function (d) {
            d3.select(this)
                .attr("r", 4);
            d3.select("#Ttitle").remove();
        });

    /*function anomaly_zoomed() {
        anomaly_svg.attr("transform", "translate(" + anomaly_zoom.translate() + ")" + "scale(" + anomaly_zoom.scale() + ")");
    }*/

    var serializer = new XMLSerializer();
    var anomaly_source = serializer.serializeToString(document.getElementById('anomaly_svg'));
    anomaly_source = '<?xml version="1.0" standalone="no"?>\r\n' + anomaly_source;
    var anomaly_url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(anomaly_source);
    var anomaly_canvas = document.createElement("canvas");
    anomaly_canvas.width = analysis_svgsize*1.1;
    anomaly_canvas.height = analysis_svgsize*1.1;
    var anomaly_context = anomaly_canvas.getContext("2d");
    var anomaly_image = new Image;
    anomaly_image.src = anomaly_url;
    anomaly_image.onload = function () {
        anomaly_context.drawImage(anomaly_image, 0, 0);
        anomaly_svg_url = anomaly_canvas.toDataURL("image/png");
    };
    </script>
<!--visualization-->
<script>
    draw_parallel();
    draw_scatter();
    draw_radviz();
</script>
<!--report-->
<script>
    function download_report() {
        var type = "docx";
        var data = {
            title: "The Analysis Report",
            clean: "1. Clean",
            clean_content: "   There is no missing value.",
            statistics: "2. Statistics Analysis",
            statistics_content: statistics_strings,
            attributes: "3. Attributes Analysis(Correlation Plot, Causality)",
            attributions_img: attributions_svg_url,
            attributes_content: attributes_string,
            cluster: "4. Cluster Analysis (k-means by default)",
            cluster_img: cluster_svg_url,
            cluster_content: cluster_strings,
            outlier: "5. Outlier Detection",
            outlier_img: anomaly_svg_url,
            outlier_content: "  We also detected some outliers. There is no outlier.",
            projection: "6. Feature Projection (PCA by default)",
            projection_content: embedding_string,
            contextual: "7. Contextual Analysis (Parallel Coordinates)",
            contextual_img: radviz_svg_url,
            contextual_content: "   Finally, we applied Parallel Coordinates to detect the relations between samples and attributes."
        };
        XDoc.to(baidu.template('report_tmpl', data), type, {});
    }
</script>
<script id="report_tmpl" type="text/html">
    <xdoc version="A.3.0">
        <body>
        <para>
            <text class="report_head" fontName="Calibri" fontSize="30"><%=title%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="20"><%=clean%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="14"><%=clean_content%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="20"><%=statistics%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="14"><%=statistics_content%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="20"><%=attributes%></text>
        </para>
        <para>
            <img src="<%=attributions_img%>" sizeType="autosize"/>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="14"><%=attributes_content%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="20"><%=cluster%></text>
        </para>
        <para>
            <img src="<%=cluster_img%>" sizeType="autosize"/>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="14"><%=cluster_content%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="20"><%=outlier%></text>
        </para>
        <para>
            <img src="<%=outlier_img%>" sizeType="autosize"/>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="14"><%=outlier_content%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="20"><%=projection%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="14"><%=projection_content%></text>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="20"><%=contextual%></text>
        </para>
        <para>
            <img src="<%=contextual_img%>" sizeType="autosize"/>
        </para>
        <para>
            <text class="report_content" fontName="Calibri" fontSize="14"><%=contextual_content%></text>
        </para>
        </body>
    </xdoc>
</script>







    
{% endblock %}